# UpperAtmPy Development Roadmap

> **Created:** 2026-01-07  
> **Status:** Planning  
> **Author:** AI Assistant

---

## Overview

This document outlines the planned features, optimizations, and improvements for UpperAtmPy based on a comprehensive codebase analysis. Items are prioritized by impact and effort.

---

## üî¥ High Priority

### 1. Integrate MSIS-00 into `TempDensityModel`

**Problem:** Currently, `TempDensityModel` only wraps NRLMSIS-2.0. The `pymsis00` module exists but isn't accessible through the unified interface.

**Solution:** Add a `model_version` parameter to switch between MSIS-2.0 and MSIS-00.

**Target API:**
```python
from model import TempDensityModel

model_20 = TempDensityModel(model_version="msis2")   # NRLMSIS-2.0 (default)
model_00 = TempDensityModel(model_version="msis00")  # NRLMSISE-00

result = model_00.calculate_point(...)  # Same API for both!
```

**Files to modify:**
- `model/temp_density_model.py`
- `model/__init__.py`

**Effort:** 2-4 hours

---

### 2. Integrate HWM93 into `WindModel`

**Problem:** Same issue as above - `WindModel` only wraps HWM14. The `pyhwm93` module is separate and inconsistent.

**Solution:** Add a `model_version` parameter to `WindModel`.

**Target API:**
```python
from model import WindModel

wind_14 = WindModel(model_version="hwm14")  # HWM14 (default)
wind_93 = WindModel(model_version="hwm93")  # HWM93

meridional, zonal = wind_93.calculate_point(...)  # Same API!
```

**Files to modify:**
- `model/wind_model.py`
- `model/__init__.py`

**Effort:** 2-4 hours

---

### 3. Remove Debug Prints in `pyhwm93`

**Problem:** Lines 35-37, 46-47, 52-53, 57, 62-66 in `model/pyhwm93/__init__.py` contain leftover debug `print()` statements that spam the user console on import.

**Solution:** Remove or convert to `logging.debug()` calls.

**Files to modify:**
- `model/pyhwm93/__init__.py`

**Effort:** 15 minutes

---

## üü° Medium Priority

### 4. Add `WindResult` Dataclass

**Problem:** API inconsistency - `TempDensityModel.calculate_point()` returns a proper `TempDensityResult` dataclass, but `WindModel.calculate_point()` returns a raw `Tuple[float, float]`.

**Solution:** Create a `WindResult` dataclass for consistency.

**Target API:**
```python
@dataclass
class WindResult:
    """È£éÂú∫ËÆ°ÁÆóÁªìÊûú"""
    alt_km: float
    meridional_wind_ms: float  # ÁªèÂêëÈ£é (m/s), Ê≠£ÂÄº‰∏∫Âåó
    zonal_wind_ms: float       # Á∫¨ÂêëÈ£é (m/s), Ê≠£ÂÄº‰∏∫‰∏ú

# Usage
result = wind_model.calculate_point(...)
print(result.meridional_wind_ms)  # Instead of result[0]
```

**Files to modify:**
- `model/wind_model.py`
- `model/__init__.py`

**Effort:** 1 hour

---

### 5. Add `datetime` Convenience Methods

**Problem:** Users must manually call `convert_date_to_day()` and `calculate_seconds_of_day()`. This is error-prone.

**Solution:** Add methods that accept Python `datetime` objects directly.

**Target API:**
```python
from datetime import datetime
from model import TempDensityModel

model = TempDensityModel()
dt = datetime(2023, 7, 15, 12, 30, 0)

# New: Direct datetime input
result = model.calculate_point_at_datetime(
    dt=dt,
    alt_km=100.0,
    lat_deg=35.0,
    lon_deg=116.0,
    f107a=100.0,
    f107=100.0
)
```

**Files to modify:**
- `model/temp_density_model.py`
- `model/wind_model.py`

**Effort:** 1-2 hours

---

### 6. Add Input Validation

**Problem:** No validation for parameter ranges. Invalid inputs (e.g., `alt_km < 0`, `lat_deg > 90`) silently produce wrong results or crash.

**Solution:** Add validation with clear Chinese error messages.

**Examples:**
```python
if not (0 <= alt_km <= 1000):
    raise ValueError(f"alt_km ÂøÖÈ°ªÂú® 0-1000 km ËåÉÂõ¥ÂÜÖÔºåÂΩìÂâçÂÄº: {alt_km}")

if not (-90 <= lat_deg <= 90):
    raise ValueError(f"lat_deg ÂøÖÈ°ªÂú® -90 Âà∞ 90 Â∫¶ËåÉÂõ¥ÂÜÖÔºåÂΩìÂâçÂÄº: {lat_deg}")
```

**Files to modify:**
- `model/temp_density_model.py`
- `model/wind_model.py`
- `model/pymsis2/__init__.py`
- `model/pyhwm14/__init__.py`

**Effort:** 2 hours

---

### 7. Add `pyproject.toml` / `requirements.txt`

**Problem:** Dependencies are not formally specified, making installation difficult.

**Solution:** Create a modern `pyproject.toml` with optional dependency groups.

**Target structure:**
```toml
[project]
name = "upperatmpy"
version = "0.1.0"
description = "Python wrapper for upper atmospheric models (MSIS, HWM)"
requires-python = ">=3.8"
dependencies = [
    "numpy>=1.20.0",
]

[project.optional-dependencies]
full = [
    "pandas>=1.3.0",
    "xarray>=0.19.0",
    "tqdm>=4.60.0",
]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
]
```

**Files to create:**
- `pyproject.toml`
- `requirements.txt` (for legacy compatibility)

**Effort:** 30 minutes

---

### 8. Add Formal Test Suite (pytest)

**Problem:** Only example scripts exist in `example/`. No proper unit tests with assertions.

**Solution:** Create a `tests/` directory with pytest-based tests.

**Target structure:**
```
tests/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ conftest.py              # Fixtures (model instances)
‚îú‚îÄ‚îÄ test_temp_density.py     # TempDensityModel tests
‚îú‚îÄ‚îÄ test_wind.py             # WindModel tests
‚îú‚îÄ‚îÄ test_msis2.py            # Low-level MSIS2 tests
‚îú‚îÄ‚îÄ test_hwm14.py            # Low-level HWM14 tests
‚îî‚îÄ‚îÄ test_utils.py            # Utility function tests
```

**Effort:** 4-6 hours

---

## üü¢ Lower Priority

### 9. xarray/pandas Output Support

**Problem:** Grid computations return lists of dicts, which are awkward for scientific analysis.

**Solution:** Add `output_as_xarray` option that returns an `xarray.Dataset` with proper coordinates and metadata.

**Target API:**
```python
ds = compute_region_msis(..., output_as_xarray=True)
# Returns xarray.Dataset with dims: (lat, lon, alt)
# Variables: T_local_K, N2_density, O_density, etc.
# Coordinates: lat, lon, alt_km
# Attrs: date, f107, f107a, model_version
```

**Effort:** 4 hours

---

### 10. Parallel Batch Processing

**Problem:** Current batch operations use Python loops calling the DLL sequentially.

**Solution:** Use `concurrent.futures.ThreadPoolExecutor` for parallel DLL calls (GIL is released during ctypes calls).

**Potential speedup:** 4-8x on multi-core systems

**Effort:** 4-6 hours

---

### 11. Automatic F10.7/Ap Index Fetching

**Problem:** Users must manually find and input solar/geomagnetic indices.

**Solution:** Add optional integration with space weather data sources.

**Target API:**
```python
from model.space_weather import get_indices

# Fetch from CelesTrak or NOAA SWPC
f107, f107a, ap = get_indices(datetime(2023, 7, 15))

result = model.calculate_point(
    ...,
    f107=f107,
    f107a=f107a,
    ap7=ap
)
```

**Effort:** 6-8 hours

---

### 12. Results Caching / Memoization

**Problem:** Repeated calls with identical parameters waste computation.

**Solution:** Add LRU caching for DLL calls.

```python
from functools import lru_cache

@lru_cache(maxsize=10000)
def _cached_calc(day, utsec, alt_km, lat_deg, lon_deg, f107a, f107, ap7_tuple):
    ...
```

**Effort:** 2 hours

---

## Implementation Order (Recommended)

| Phase | Items | Total Effort |
|-------|-------|--------------|
| **Phase 1: Quick Wins** | #3 (debug prints), #7 (pyproject.toml) | 1 hour |
| **Phase 2: API Consistency** | #1 (MSIS-00), #2 (HWM93), #4 (WindResult) | 5-9 hours |
| **Phase 3: DX Improvements** | #5 (datetime), #6 (validation) | 3-4 hours |
| **Phase 4: Quality** | #8 (tests) | 4-6 hours |
| **Phase 5: Advanced** | #9 (xarray), #10 (parallel), #11 (indices), #12 (cache) | 16-20 hours |

---

## Notes

- All Chinese docstrings and error messages should be preserved per project conventions
- Windows-only DLL loading patterns must be maintained
- Backward compatibility with existing API is required (new parameters should have defaults)
